<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Pocket Bowl Retry</title>
	<style>
		/* Basic page reset */
		body {
			margin: 0;
			background: #222;
			height: 100vh;
			color: white;
			font-family: monospace;
		}

		/* Layout wrapper */
		#layout {
			display: flex;
			justify-content: center;
			align-items: center;
			gap: 24px;
			height: 100vh;
			padding: 20px;
			box-sizing: border-box;
		}

		/* Controls panel */
		#controlsPanel {
			width: 260px;
			height: 900px;
			background: #111;
			border: 2px solid #2f2f2f;
			box-shadow: 0 0 20px rgba(0,0,0,0.5);
			padding: 16px;
			box-sizing: border-box;
			display: flex;
			flex-direction: column;
			gap: 12px;
		}
		#controlsPanel h2 {
			margin: 0 0 6px 0;
			font-size: 18px;
			text-align: center;
		}
		#controlsPanel .section {
			background: #1a1a1a;
			border: 1px solid #2c2c2c;
			padding: 10px;
			border-radius: 6px;
		}
		#controlsPanel ul {
			margin: 8px 0 0 0;
			padding: 0 0 0 16px;
		}
		#controlsPanel li {
			margin: 4px 0;
		}
		#controlsPanel .hint {
			color: #b5b5b5;
			font-size: 12px;
		}

		/* Game container */
		#gameContainer {
			position: relative;
			width: 540px;
			height: 900px;
			box-shadow: 0 0 20px rgba(0,0,0,0.5);
			background: black;
		}
		canvas {
			background: #2e8b57;
		}

		/* HUD overlay */
		#ui-layer {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			pointer-events: none;
			display: flex;
			flex-direction: column;
			justify-content: space-between;
			padding: 20px;
			box-sizing: border-box;
		}
		#sidePanel {
			width: 220px;
			height: 900px;
			background: #111;
			border: 2px solid #2f2f2f;
			box-shadow: 0 0 20px rgba(0,0,0,0.5);
			padding: 16px;
			box-sizing: border-box;
			display: flex;
			flex-direction: column;
			gap: 12px;
		}
		#sidePanel h2 {
			margin: 0 0 6px 0;
			font-size: 18px;
			text-align: center;
		}
		#hudButtons {
			display: flex;
			flex-direction: column;
			gap: 10px;
		}
		#settingsBtn {
			background: #4aa3ff;
			color: #0b0b0b;
		}
		#settingsModal {
			display: none;
			background: #111;
			border: 2px solid #2f2f2f;
			box-shadow: 0 0 20px rgba(0,0,0,0.5);
			padding: 16px;
			border-radius: 6px;
		}
		#settingsModal.active {
			display: block;
		}
		.settingsRow {
			display: flex;
			flex-direction: column;
			gap: 6px;
			margin-top: 10px;
		}
		.settingsRow input {
			padding: 8px;
			border-radius: 4px;
			border: 1px solid #2c2c2c;
			background: #1a1a1a;
			color: white;
			font-family: monospace;
		}
		.settingsActions {
			display: flex;
			gap: 10px;
			margin-top: 12px;
		}
		#savePlayBtn {
			background: #1e1e1e;
			color: white;
			border: 1px solid #2c2c2c;
		}
		h1 {
			margin: 0;
			text-shadow: 2px 2px black;
		}
		#timer {
			font-size: 40px;
			color: yellow;
			font-weight: bold;
		}
		button {
			pointer-events: auto;
			padding: 10px 20px;
			cursor: pointer;
			font-size: 16px;
			background: orange;
			border: none;
			font-weight: bold;
		}
	</style>
</head>
<body>

<!-- Layout -->
<div id="layout">
	<!-- Controls Panel -->
	<aside id="controlsPanel">
		<h2>CONTROLS</h2>
		<div class="section">
			<div><strong>Prep</strong></div>
			<div>Drag blue players to draw routes.</div>
		</div>
		<div class="section">
			<div><strong>Throw</strong></div>
			<div>Press 1â€“5 to pass. Hold to lob.</div>
			<ul id="receiverList"></ul>
			<div class="hint">Numbers map to the labeled receivers on the field.</div>
		</div>
		<div class="section">
			<div><strong>Snap</strong></div>
			<div>Click SNAP BALL to start the play.</div>
		</div>
	</aside>

	<!-- Game Container -->
	<div id="gameContainer">
		<canvas id="gameCanvas" width="540" height="900"></canvas>

		<!-- HUD -->
		<div id="ui-layer">
			<div style="text-align:center;">
				<h1>POCKET BOWL</h1>
				<div id="timer">PREP: 5</div>
			</div>
		</div>
	</div>

	<!-- Right Side Buttons Panel -->
	<aside id="sidePanel">
		<h2>GAME</h2>
		<div id="hudButtons">
			<button id="snapBtn" tabindex="-1">SNAP BALL</button>
			<button id="pauseBtn" tabindex="-1">PAUSE</button>
			<button id="resetBtn" tabindex="-1">RESET</button>
			<button id="settingsBtn" tabindex="-1">GAME SETTINGS</button>
		</div>
		<div id="settingsModal">
			<div><strong>Settings</strong></div>
			<div class="settingsRow">
				<label for="yardLineInput">Start play at which yard line? (0-100)</label>
				<input id="yardLineInput" type="number" min="0" max="100" value="35" />
			</div>
			<div class="settingsRow">
				<label for="playNameInput">Name your play</label>
				<input id="playNameInput" type="text" placeholder="My Play" />
			</div>
			<div class="settingsActions">
				<button id="saveSettingsBtn" type="button">Save Yard Line</button>
				<button id="savePlayBtn" type="button">Save Last Play</button>
			</div>
		</div>
	</aside>
</div>

<!-- HUD Button Logic (Step 1 only) -->
<script>
	const pauseBtn = document.getElementById("pauseBtn");
	const resetBtn = document.getElementById("resetBtn");
	const settingsBtn = document.getElementById("settingsBtn");
	const settingsModal = document.getElementById("settingsModal");
	const yardLineInput = document.getElementById("yardLineInput");
	const playNameInput = document.getElementById("playNameInput");
	const saveSettingsBtn = document.getElementById("saveSettingsBtn");
	const savePlayBtn = document.getElementById("savePlayBtn");
	const timerLabel = document.getElementById("timer");
	let paused = false;

	pauseBtn.addEventListener("click", () => {
		paused = !paused;
		pauseBtn.textContent = paused ? "RESUME" : "PAUSE";
		timerLabel.textContent = paused ? "PAUSED" : "PREP: 5";
	});

	resetBtn.addEventListener("click", () => {
		window.location.reload();
	});

	settingsBtn.addEventListener("click", () => {
		settingsModal.classList.toggle("active");
	});

	saveSettingsBtn.addEventListener("click", () => {
		const parsed = Number(yardLineInput.value);
		if (!Number.isNaN(parsed)) {
			const clamped = Math.max(0, Math.min(100, parsed));
			localStorage.setItem("retry-yard-line", String(clamped));
			yardLineInput.value = String(clamped);
			if (typeof applyFormationToLine === "function") {
				applyFormationToLine(yardLineToY(clamped));
			}
		}
	});

	savePlayBtn.addEventListener("click", () => {
		const playName = playNameInput.value.trim();
		if (!playName) return;
		const yardLine = Number(localStorage.getItem("retry-yard-line") ?? "35");
		const payload = {
			name: playName,
			yardLine,
			roster: typeof roster !== "undefined" ? roster.map(p => ({
				id: p.id,
				team: p.team,
				role: p.role,
				x: p.x,
				y: p.y,
				path: p.path ?? []
			})) : [],
			savedAt: new Date().toISOString()
		};
		localStorage.setItem(`retry-play-${playName}`, JSON.stringify(payload));
		localStorage.setItem("retry-last-play", playName);
		playNameInput.value = "";
	});
</script>

<!-- Core Data Models (Step 2) -->
<script>
	const FIELD_WIDTH = 540;
	const FIELD_HEIGHT = 900;
	const ENDZONE_HEIGHT = 50;
	const YARDS_PER_FIELD = 100;
	const DEFAULT_YARD_LINE = 35;
	const FIELD_TOP_Y = ENDZONE_HEIGHT;
	const FIELD_BOTTOM_Y = FIELD_HEIGHT - ENDZONE_HEIGHT;
	const FIELD_PLAY_HEIGHT = FIELD_BOTTOM_Y - FIELD_TOP_Y;
	const LINE_COLOR = "rgba(255,255,255,0.3)";
	const LOS_COLOR = "rgba(255,255,255,0.8)";

	class Player {
		constructor(id, x, y, team, role) {
			this.id = id;
			this.x = x;
			this.y = y;
			this.startX = x;
			this.startY = y;
			this.baseX = x;
			this.baseYOffset = 0;
			this.team = team; // "offense" or "defense"
			this.role = role; // "QB", "WR", "LB"
			this.path = [];
			this.pathIndex = 0;
			this.speed = 3.0;
			this.hasBall = (role === "QB");
			this.isDead = false;
		}

		reset() {
			this.x = this.startX;
			this.y = this.startY;
			this.path = [];
			this.pathIndex = 0;
			this.isDead = false;
			this.hasBall = (this.role === "QB");
		}
	}

	const roster = [
		// --- OFFENSE (Blue) ---
		new Player(1, 270, 820, "offense", "QB"),
		new Player(2, 150, 760, "offense", "WR"),
		new Player(3, 390, 760, "offense", "WR"),
		new Player(4, 270, 860, "offense", "RB"),
		new Player(5, 220, 760, "offense", "SL"),
		new Player(6, 320, 760, "offense", "SL"),
		new Player(7, 270, 760, "offense", "TE"),

		// --- DEFENSE (Red) ---
		new Player(8, 270, 700, "defense", "MLB"),
		new Player(9, 170, 700, "defense", "LB"),
		new Player(10, 370, 700, "defense", "LB"),
		new Player(11, 120, 620, "defense", "CB"),
		new Player(12, 420, 620, "defense", "CB"),
		new Player(13, 270, 580, "defense", "S"),
		new Player(14, 220, 700, "defense", "DL"),
		new Player(15, 320, 700, "defense", "DL")
	];

	function yardLineToY(yardLine) {
		const clamped = Math.max(0, Math.min(100, yardLine));
		const percent = clamped / YARDS_PER_FIELD;
		return FIELD_BOTTOM_Y - (percent * FIELD_PLAY_HEIGHT);
	}

	function setFormationOffsets() {
		roster.forEach(player => {
			player.baseX = player.x;
			player.baseYOffset = player.y - DEFAULT_LINE_OF_SCRIMMAGE_Y;
		});
	}

	function applyFormationToLine(lineY) {
		roster.forEach(player => {
			player.x = player.baseX;
			player.y = lineY + player.baseYOffset;
			player.startX = player.x;
			player.startY = player.y;
		});
	}

	const DEFAULT_LINE_OF_SCRIMMAGE_Y = yardLineToY(DEFAULT_YARD_LINE);

	function getLineOfScrimmageY() {
		const stored = Number(localStorage.getItem("retry-yard-line") ?? DEFAULT_YARD_LINE);
		return yardLineToY(stored);
	}

	setFormationOffsets();
	applyFormationToLine(getLineOfScrimmageY());

	console.log("[Step 2] Roster initialized:", roster);
</script>

<!-- Render Loop (Step 3) -->
<script>
	const canvas = document.getElementById("gameCanvas");
	const ctx = canvas.getContext("2d");

	function drawField() {
		ctx.clearRect(0, 0, canvas.width, canvas.height);

		ctx.strokeStyle = LINE_COLOR;
		ctx.lineWidth = 2;
		for (let i = 0; i < canvas.height; i += 50) {
			ctx.beginPath();
			ctx.moveTo(0, i);
			ctx.lineTo(canvas.width, i);
			ctx.stroke();
		}

		ctx.fillStyle = "rgba(0,0,100,0.2)";
		ctx.fillRect(0, 0, canvas.width, ENDZONE_HEIGHT);
		ctx.fillRect(0, canvas.height - ENDZONE_HEIGHT, canvas.width, ENDZONE_HEIGHT);

		const losY = getLineOfScrimmageY();
		ctx.strokeStyle = LOS_COLOR;
		ctx.lineWidth = 3;
		ctx.setLineDash([10, 6]);
		ctx.beginPath();
		ctx.moveTo(0, losY);
		ctx.lineTo(canvas.width, losY);
		ctx.stroke();
		ctx.setLineDash([]);
	}

	function drawPlayers() {
		roster.forEach(p => {
			ctx.fillStyle = "rgba(0,0,0,0.5)";
			ctx.beginPath();
			ctx.arc(p.x + 2, p.y + 2, 15, 0, Math.PI * 2);
			ctx.fill();

			ctx.fillStyle = (p.team === "offense") ? "#0099ff" : "#ff3300";
			ctx.beginPath();
			ctx.arc(p.x, p.y, 15, 0, Math.PI * 2);
			ctx.fill();

			if (p.hasBall) {
				ctx.fillStyle = "brown";
				ctx.beginPath();
				ctx.arc(p.x, p.y, 8, 0, Math.PI * 2);
				ctx.fill();
			}

			ctx.fillStyle = "white";
			ctx.font = "10px Arial";
			ctx.textAlign = "center";
			ctx.fillText(p.role, p.x, p.y + 4);
		});
	}

	function render() {
		drawField();
		drawPlayers();
		requestAnimationFrame(render);
	}

	render();
</script>

</body>
</html>
